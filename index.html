<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Tính Khoản Vay</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opentype.js/dist/opentype.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            min-width: 200px;
        }
        button:hover {
            background-color: #3a506b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
            text-align: center;
        }
        .result {
            margin-top: 30px;
        }
        .result h2 {
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 5px;
            color: #2c3e50;
        }
        .text-center {
            text-align: center;
        }
        .info-table {
            margin-bottom: 20px;
        }
        .info-table td:first-child {
            font-weight: bold;
            width: 40%;
        }
        
        /* Phần in ấn */
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 0;
            }
            .container {
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                padding: 10px;
                border-radius: 0;
            }
            .form-container, button, .tab, .tabs {
                display: none;
            }
            .result {
                display: block !important;
            }
            table {
                width: 100%;
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            h1, h2 {
                text-align: center;
                margin: 10px 0;
            }
        }
        
        /* Nút in */
        .print-button {
            background-color: #27ae60;
        }
        .print-button:hover {
            background-color: #2ecc71;
        }
        
        /* Menu và Tabs */
        .tabs {
            overflow: hidden;
            background-color: #f1f1f1;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .tab {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            margin: 0;
            min-width: auto;
            border-radius: 0;
        }
        .tab:hover {
            background-color: #ddd;
        }
        .tab.active {
            background-color: #2c3e50;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border-top: none;
            animation: fadeEffect 1s;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        
        /* Thông báo kết quả */
        .result-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Công cụ Tính Khoản Vay</h1>
        
        <!-- Menu tabs -->
        <div class="tabs">
            <button class="tab active" onclick="openTab(event, 'loanCalculator')">Tính khoản vay</button>
            <button class="tab" onclick="openTab(event, 'earlyPayment')">Tính phí trả nợ trước hạn</button>
            <button class="tab" onclick="openTab(event, 'interestRefundCalculator')">Thu hồi ưu đãi lãi suất</button>
        </div>
        
        <!-- Tab Tính khoản vay -->
        <div id="loanCalculator" class="tabcontent" style="display: block;">
            <div class="form-container">
                <div class="form-group">
                    <label for="loanAmountFormatted">Số tiền vay vốn (VND)</label>
                    <input type="text" id="loanAmountFormatted" value="1.000.000.000" required>
                    <input type="hidden" id="loanAmount" value="1000000000">
                </div>
                
                <div class="form-group">
                    <label for="loanTerm">Thời hạn vay vốn (tháng)</label>
                    <input type="number" id="loanTerm" value="24" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="promotionalRate">Lãi suất ưu đãi (%/năm)</label>
                    <input type="number" id="promotionalRate" value="8" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="promotionalPeriod">Thời gian ưu đãi lãi suất (tháng)</label>
                    <input type="number" id="promotionalPeriod" value="6" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="floatingRate">Lãi suất thả nổi (%/năm)</label>
                    <input type="number" id="floatingRate" value="12" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="startDate">Ngày vay vốn</label>
                    <input type="date" id="startDate" required>
                </div>
                
                <div class="form-group">
                    <label for="paymentDay">Ngày trả gốc, lãi hàng tháng</label>
                    <input type="number" id="paymentDay" value="10" min="1" max="31" required>
                </div>
                
                <button onclick="calculateAndDisplay()">Tính toán</button>
                <button onclick="downloadExcel()">Tải xuống Excel</button>
                <button onclick="printDocument()">In báo cáo</button>
            </div>
            
            <div class="result" id="resultContainer" style="display: none;">
                <h2>Thông tin khoản vay</h2>
                <table class="info-table">
                    <tbody id="loanInfoTable"></tbody>
                </table>
                
                <h2>Lịch trả nợ</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Ngày thanh toán</th>
                                <th>Số tiền gốc (VND)</th>
                                <th>Số tiền lãi (VND)</th>
                                <th>Gốc + Lãi (VND)</th>
                                <th>Dư nợ còn lại (VND)</th>
                            </tr>
                        </thead>
                        <tbody id="paymentScheduleTable"></tbody>
                        <tfoot id="paymentTotalsTable"></tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab Tính phí trả nợ trước hạn -->
        <div id="earlyPayment" class="tabcontent">
            <div class="form-container">
                <div class="form-group">
                    <label for="earlyPaymentAmountFormatted">Số tiền trả nợ trước hạn (VND)</label>
                    <input type="text" id="earlyPaymentAmountFormatted" value="1.000.000.000" required>
                    <input type="hidden" id="earlyPaymentAmount" value="1000000000">
                </div>
                
                <div class="form-group">
                    <label for="earlyPaymentYear">Năm trả nợ trước hạn</label>
                    <select id="earlyPaymentYear" required>
                        <option value="1">Năm 1</option>
                        <option value="2">Năm 2</option>
                        <option value="3">Năm 3</option>
                        <option value="4">Năm 4</option>
                        <option value="5">Năm 5</option>
                        <option value="6">Năm 6 trở đi</option>
                    </select>
                </div>
                
                <button onclick="calculateEarlyPayment()">Tính phí trả nợ trước hạn</button>
            </div>
            
            <div id="earlyPaymentResult" class="result-message" style="display: none;"></div>
        </div>
        
        <!-- Tab Thu hồi ưu đãi lãi suất -->
        <div id="interestRefundCalculator" class="tabcontent">
            <div class="form-container">
                <div class="form-group">
                    <label for="refundLoanAmountFormatted">Dư nợ gốc thực tế (VND)</label>
                    <input type="text" id="refundLoanAmountFormatted" value="1.000.000.000" required>
                    <input type="hidden" id="refundLoanAmount" value="1000000000">
                </div>
                
                <div class="form-group">
                    <label for="standardRate">Lãi suất thả nổi/theo thỏa thuận (%/năm)</label>
                    <input type="number" id="standardRate" value="12" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="prefRate">Lãi suất ưu đãi (%/năm)</label>
                    <input type="number" id="prefRate" value="8" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="promotionalMonths">Thời gian ưu đãi tính theo tháng</label>
                    <input type="number" id="promotionalMonths" value="12" min="1" step="1" required>
                </div>
                
                <div class="form-group">
                    <label for="loanStartDate">Ngày vay</label>
                    <input type="date" id="loanStartDate" required>
                </div>
                
                <div class="form-group">
                    <label for="loanEndDate">Ngày trả nợ</label>
                    <input type="date" id="loanEndDate" required>
                </div>
                
                <div class="form-group">
                    <label for="actualDays">Số ngày thực hưởng ưu đãi</label>
                    <input type="number" id="actualDays" value="182" min="1" max="3650" required>
                </div>
                
                <div class="form-group">
                    <label for="calculationMethod">Phương pháp tính</label>
                    <select id="calculationMethod" required>
                        <option value="actual365">Actual/365</option>
                        <option value="actual360">Actual/360</option>
                    </select>
                </div>
                
                <button onclick="calculateInterestRefund()">Tính tiền thu hồi ưu đãi</button>
                <button id="generateReportBtn" onclick="generateReport()" style="display: none;">Xuất báo cáo</button>
            </div>
            
            <div id="interestRefundResult" class="result-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Thiết lập ngày hôm nay cho trường nhập ngày
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            document.getElementById('startDate').value = formattedDate;
            
            // Thêm sự kiện định dạng số cho trường Số tiền vay
            const loanAmountFormatted = document.getElementById('loanAmountFormatted');
            loanAmountFormatted.addEventListener('input', function() {
                formatCurrency('loanAmountFormatted', 'loanAmount');
            });
            loanAmountFormatted.addEventListener('focus', function(e) {
                // Di chuyển con trỏ đến cuối khi focus
                const val = e.target.value;
                e.target.value = '';
                e.target.value = val;
            });
            
            // Thêm sự kiện định dạng số cho trường Số tiền trả nợ trước hạn
            const earlyPaymentAmountFormatted = document.getElementById('earlyPaymentAmountFormatted');
            earlyPaymentAmountFormatted.addEventListener('input', function() {
                formatCurrency('earlyPaymentAmountFormatted', 'earlyPaymentAmount');
            });
            earlyPaymentAmountFormatted.addEventListener('focus', function(e) {
                // Di chuyển con trỏ đến cuối khi focus
                const val = e.target.value;
                e.target.value = '';
                e.target.value = val;
            });
            
            // Thêm sự kiện định dạng số cho trường Thu hồi ưu đãi lãi suất
            const refundLoanAmountFormatted = document.getElementById('refundLoanAmountFormatted');
            if (refundLoanAmountFormatted) {
                refundLoanAmountFormatted.addEventListener('input', function() {
                    formatCurrency('refundLoanAmountFormatted', 'refundLoanAmount');
                });
                refundLoanAmountFormatted.addEventListener('focus', function(e) {
                    // Di chuyển con trỏ đến cuối khi focus
                    const val = e.target.value;
                    e.target.value = '';
                    e.target.value = val;
                });
            }
            
            // Thiết lập ngày hôm nay cho trường ngày vay và ngày trả nợ
            const loanStartDate = document.getElementById('loanStartDate');
            const loanEndDate = document.getElementById('loanEndDate');
            if (loanStartDate && loanEndDate) {
                const today = new Date();
                const formattedDate = today.toISOString().substr(0, 10);
                loanStartDate.value = formattedDate;
                
                // Thiết lập ngày trả nợ mặc định là 6 tháng sau ngày vay
                const sixMonthsLater = new Date(today);
                sixMonthsLater.setMonth(today.getMonth() + 6);
                loanEndDate.value = sixMonthsLater.toISOString().substr(0, 10);
                
                // Thêm sự kiện để tự động tính số ngày khi thay đổi ngày
                loanStartDate.addEventListener('change', calculateDaysDifference);
                loanEndDate.addEventListener('change', calculateDaysDifference);
            }
        });
        
        // Hàm định dạng tiền tệ (1000000 -> 1.000.000)
        function formatCurrency(inputId, hiddenInputId) {
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            // Xóa tất cả các ký tự không phải số
            let value = input.value.replace(/\D/g, '');
            
            // Lưu giá trị thực tế vào trường ẩn
            hiddenInput.value = value;
            
            // Định dạng hiển thị với dấu phân cách hàng nghìn
            if (value === '') {
                input.value = '';
            } else {
                // Định dạng với dấu chấm phân cách hàng nghìn
                input.value = parseInt(value).toLocaleString('de-DE'); // Sử dụng 'de-DE' cho dấu chấm phân cách
            }
        }

        // Hàm tính toán khoản vay với lãi suất ưu đãi và lãi suất thả nổi
        function calculateLoan(loanAmount, loanTerm, promotionalRate, promotionalPeriod, floatingRate, startDate, paymentDay) {
            // Chuyển đổi lãi suất từ % thành hệ số thập phân
            const promotionalMonthlyRate = promotionalRate / 100 / 12;
            const floatingMonthlyRate = floatingRate / 100 / 12;
            
            // Tính toán số tiền gốc cần trả mỗi tháng (làm tròn đến hàng nghìn)
            let monthlyPrincipal = Math.floor(loanAmount / loanTerm / 1000) * 1000;
            
            // Tính toán số tiền còn lại cho kỳ cuối cùng
            const remainingAmount = loanAmount - (monthlyPrincipal * (loanTerm - 1));
            
            // Tạo mảng để lưu trữ kết quả
            const paymentSchedule = [];
            
            // Tạo đối tượng Date từ ngày vay vốn
            const loanDate = new Date(startDate);
            
            // Thiết lập ngày trả hàng tháng
            const paymentDayOfMonth = parseInt(paymentDay);
            
            // Tính toán lịch trả nợ
            let remainingPrincipal = loanAmount;
            
            for (let month = 1; month <= loanTerm; month++) {
                // Xác định ngày thanh toán cho tháng hiện tại
                const paymentDate = new Date(loanDate);
                paymentDate.setMonth(loanDate.getMonth() + month);
                paymentDate.setDate(paymentDayOfMonth);
                
                // Xác định lãi suất áp dụng
                const currentRate = month <= promotionalPeriod ? promotionalMonthlyRate : floatingMonthlyRate;
                
                // Tính lãi cho tháng hiện tại
                const interestPayment = remainingPrincipal * currentRate;
                
                // Xác định số tiền gốc cần trả
                let principalPayment;
                if (month === loanTerm) {
                    principalPayment = remainingAmount;
                } else {
                    principalPayment = monthlyPrincipal;
                }
                
                // Tính tổng số tiền phải trả
                const totalPayment = principalPayment + interestPayment;
                
                // Cập nhật số tiền gốc còn lại
                remainingPrincipal -= principalPayment;
                
                // Thêm thông tin vào lịch trả nợ
                paymentSchedule.push({
                    month: month,
                    paymentDate: paymentDate.toLocaleDateString('vi-VN'),
                    principalPayment: Math.round(principalPayment),
                    interestPayment: Math.round(interestPayment),
                    totalPayment: Math.round(totalPayment),
                    remainingPrincipal: Math.round(remainingPrincipal)
                });
            }
            
            return paymentSchedule;
        }

        // Hàm hiển thị kết quả tính toán
        function calculateAndDisplay() {
            // Lấy giá trị từ form
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const promotionalRate = parseFloat(document.getElementById('promotionalRate').value);
            const promotionalPeriod = parseInt(document.getElementById('promotionalPeriod').value);
            const floatingRate = parseFloat(document.getElementById('floatingRate').value);
            const startDate = document.getElementById('startDate').value;
            const paymentDay = document.getElementById('paymentDay').value;
            
            // Kiểm tra dữ liệu đầu vào
            if (!loanAmount || !loanTerm || !promotionalRate || !floatingRate || !startDate || !paymentDay) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }
            
            // Tính toán lịch trả nợ
            const paymentSchedule = calculateLoan(loanAmount, loanTerm, promotionalRate, promotionalPeriod, floatingRate, startDate, paymentDay);
            
            // Hiển thị thông tin khoản vay
            const loanInfoTable = document.getElementById('loanInfoTable');
            loanInfoTable.innerHTML = `
                <tr>
                    <td>Số tiền vay</td>
                    <td>${loanAmount.toLocaleString('de-DE')} VND</td>
                </tr>
                <tr>
                    <td>Thời hạn vay</td>
                    <td>${loanTerm} tháng</td>
                </tr>
                <tr>
                    <td>Lãi suất ưu đãi</td>
                    <td>${promotionalRate}%/năm</td>
                </tr>
                <tr>
                    <td>Thời gian ưu đãi</td>
                    <td>${promotionalPeriod} tháng</td>
                </tr>
                <tr>
                    <td>Lãi suất thả nổi</td>
                    <td>${floatingRate}%/năm</td>
                </tr>
                <tr>
                    <td>Ngày vay vốn</td>
                    <td>${new Date(startDate).toLocaleDateString('vi-VN')}</td>
                </tr>
                <tr>
                    <td>Ngày trả hàng tháng</td>
                    <td>Ngày ${paymentDay} hàng tháng</td>
                </tr>
            `;
            
            // Hiển thị lịch trả nợ
            const paymentScheduleTable = document.getElementById('paymentScheduleTable');
            paymentScheduleTable.innerHTML = '';
            
            // Tính tổng
            let totalPrincipal = 0;
            let totalInterest = 0;
            let totalPayment = 0;
            
            paymentSchedule.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${payment.month}</td>
                    <td class="text-center">${payment.paymentDate}</td>
                    <td>${payment.principalPayment.toLocaleString('de-DE')}</td>
                    <td>${payment.interestPayment.toLocaleString('de-DE')}</td>
                    <td>${payment.totalPayment.toLocaleString('de-DE')}</td>
                    <td>${payment.remainingPrincipal.toLocaleString('de-DE')}</td>
                `;
                paymentScheduleTable.appendChild(row);
                
                totalPrincipal += payment.principalPayment;
                totalInterest += payment.interestPayment;
                totalPayment += payment.totalPayment;
            });
            
            // Hiển thị tổng
            const paymentTotalsTable = document.getElementById('paymentTotalsTable');
            paymentTotalsTable.innerHTML = `
                <tr>
                    <td colspan="2" class="text-center"><strong>TỔNG CỘNG</strong></td>
                    <td><strong>${totalPrincipal.toLocaleString('de-DE')}</strong></td>
                    <td><strong>${totalInterest.toLocaleString('de-DE')}</strong></td>
                    <td><strong>${totalPayment.toLocaleString('de-DE')}</strong></td>
                    <td></td>
                </tr>
            `;
            
            // Hiển thị kết quả
            document.getElementById('resultContainer').style.display = 'block';
        }

        // Hàm tạo dữ liệu Excel
        function generateExcelData(loanAmount, loanTerm, promotionalRate, promotionalPeriod, floatingRate, startDate, paymentDay) {
            // Tính toán lịch trả nợ
            const paymentSchedule = calculateLoan(loanAmount, loanTerm, promotionalRate, promotionalPeriod, floatingRate, startDate, paymentDay);
            
            // Tạo dữ liệu cho Excel
            const excelData = [];
            
            // Thêm thông tin đầu vào
            excelData.push(['THÔNG TIN KHOẢN VAY']);
            excelData.push(['Số tiền vay', loanAmount.toLocaleString('de-DE') + ' VND']);
            excelData.push(['Thời hạn vay', loanTerm + ' tháng']);
            excelData.push(['Lãi suất ưu đãi', promotionalRate + '%']);
            excelData.push(['Thời gian ưu đãi', promotionalPeriod + ' tháng']);
            excelData.push(['Lãi suất thả nổi', floatingRate + '%']);
            excelData.push(['Ngày vay vốn', new Date(startDate).toLocaleDateString('vi-VN')]);
            excelData.push(['Ngày trả hàng tháng', paymentDay]);
            excelData.push([]);
            
            // Thêm tiêu đề cho bảng lịch trả nợ
            excelData.push(['LỊCH TRẢ NỢ']);
            excelData.push(['STT', 'Ngày thanh toán', 'Số tiền gốc (VND)', 'Số tiền lãi (VND)', 'Tổng thanh toán (VND)', 'Dư nợ còn lại (VND)']);
            
            // Thêm dữ liệu cho từng kỳ thanh toán
            paymentSchedule.forEach(payment => {
                excelData.push([
                    payment.month,
                    payment.paymentDate,
                    payment.principalPayment,
                    payment.interestPayment,
                    payment.totalPayment,
                    payment.remainingPrincipal
                ]);
            });
            
            // Tính tổng
            const totalPrincipal = paymentSchedule.reduce((sum, payment) => sum + payment.principalPayment, 0);
            const totalInterest = paymentSchedule.reduce((sum, payment) => sum + payment.interestPayment, 0);
            const totalPayment = paymentSchedule.reduce((sum, payment) => sum + payment.totalPayment, 0);
            
            // Thêm thông tin tổng
            excelData.push([]);
            excelData.push(['TỔNG CỘNG', '', totalPrincipal, totalInterest, totalPayment, '']);
            
            return excelData;
        }

        // Hàm này sẽ tạo file Excel và cho phép tải xuống
        function downloadExcel() {
            // Lấy dữ liệu từ form
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const promotionalRate = parseFloat(document.getElementById('promotionalRate').value);
            const promotionalPeriod = parseInt(document.getElementById('promotionalPeriod').value);
            const floatingRate = parseFloat(document.getElementById('floatingRate').value);
            const startDate = document.getElementById('startDate').value;
            const paymentDay = document.getElementById('paymentDay').value;
            
            // Kiểm tra dữ liệu đầu vào
            if (!loanAmount || !loanTerm || !promotionalRate || !floatingRate || !startDate || !paymentDay) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }
            
            // Tạo dữ liệu Excel
            const excelData = generateExcelData(loanAmount, loanTerm, promotionalRate, promotionalPeriod, floatingRate, startDate, paymentDay);
            
            // Tạo workbook mới
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            // Thêm worksheet vào workbook
            XLSX.utils.book_append_sheet(wb, ws, "Lich_tra_no");
            
            // Tạo file Excel và tải xuống
            XLSX.writeFile(wb, "Lich_tra_no.xlsx");
        }
        
        // Hàm in báo cáo trực tiếp
        function printDocument() {
            // Kiểm tra nếu chưa tính toán thì tính toán trước
            if (document.getElementById('resultContainer').style.display === 'none') {
                calculateAndDisplay();
            }
            
            // In tài liệu
            window.print();
        }
        
        // Hàm tính phí trả nợ trước hạn
        function calculateEarlyPayment() {
            // Lấy giá trị từ form
            const earlyPaymentAmount = parseFloat(document.getElementById('earlyPaymentAmount').value);
            const earlyPaymentYear = parseInt(document.getElementById('earlyPaymentYear').value);
            
            // Kiểm tra dữ liệu đầu vào
            if (!earlyPaymentAmount || !earlyPaymentYear) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }
            
            // Tính phí trả nợ trước hạn
            let feeRate = 0;
            
            switch(earlyPaymentYear) {
                case 1:
                case 2:
                    feeRate = 2; // 2% trong năm 1, năm 2
                    break;
                case 3:
                    feeRate = 1.5; // 1.5% trong năm 3
                    break;
                case 4:
                case 5:
                    feeRate = 1; // 1% trong năm 4, năm 5
                    break;
                default:
                    feeRate = 0; // 0% từ năm 6 trở đi
            }
            
            const earlyPaymentFee = earlyPaymentAmount * (feeRate / 100);
            
            // Hiển thị kết quả
            const resultElement = document.getElementById('earlyPaymentResult');
            resultElement.innerHTML = `
                <p>Thông tin tính phí trả nợ trước hạn:</p>
                <p>- Số tiền trả nợ trước hạn: ${earlyPaymentAmount.toLocaleString('de-DE')} VND</p>
                <p>- Thời điểm trả nợ: Năm ${earlyPaymentYear}</p>
                <p>- Tỷ lệ phí: ${feeRate}%</p>
                <p>- Phí trả nợ trước hạn: ${earlyPaymentFee.toLocaleString('de-DE')} VND</p>
            `;
            resultElement.style.display = 'block';
        }
        
        // Hàm chuyển đổi giữa các tab
        function openTab(evt, tabName) {
            // Ẩn tất cả nội dung tab
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Xóa trạng thái active của tất cả các nút tab
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].className = tabs[i].className.replace(" active", "");
            }
            
            // Hiển thị tab hiện tại và đánh dấu nút tab là active
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        // Hàm tính số ngày giữa hai ngày
        function calculateDaysDifference() {
            const startDate = new Date(document.getElementById('loanStartDate').value);
            const endDate = new Date(document.getElementById('loanEndDate').value);
            
            if (startDate && endDate) {
                // Tính số mili giây giữa hai ngày
                const diffTime = endDate - startDate;
                // Chuyển đổi sang số ngày và làm tròn lên
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Cập nhật trường số ngày
                if (diffDays > 0) {
                    document.getElementById('actualDays').value = diffDays;
                } else {
                    alert('Ngày trả nợ phải sau ngày vay!');
                }
            }
        }
        
        // Hàm tính thu hồi ưu đãi lãi suất
        function calculateInterestRefund() {
            // Lấy giá trị từ form
            const loanAmount = parseFloat(document.getElementById('refundLoanAmount').value);
            const standardRate = parseFloat(document.getElementById('standardRate').value);
            const prefRate = parseFloat(document.getElementById('prefRate').value);
            const promotionalMonths = parseInt(document.getElementById('promotionalMonths').value);
            const actualDays = parseInt(document.getElementById('actualDays').value);
            const calculationMethod = document.getElementById('calculationMethod').value;
            const startDate = document.getElementById('loanStartDate').value;
            const endDate = document.getElementById('loanEndDate').value;
            
            // Kiểm tra dữ liệu đầu vào
            if (!loanAmount || !standardRate || !prefRate || !promotionalMonths || !actualDays || !startDate || !endDate) {
                alert('Vui lòng nhập đầy đủ thông tin!');
                return;
            }
            
            // Xác định số ngày trong năm tính toán
            const daysInYear = calculationMethod === 'actual365' ? 365 : 360;
            
            // Tính chênh lệch lãi suất
            const rateDiff = (standardRate - prefRate) / 100;
            
            // Tính tiền thu hồi ưu đãi
            const interestRefund = loanAmount * rateDiff * (actualDays / daysInYear);
            
            // Lưu thông tin cho báo cáo
            window.reportData = {
                loanAmount,
                standardRate,
                prefRate,
                promotionalMonths,
                actualDays,
                calculationMethod,
                startDate,
                endDate,
                rateDiff,
                interestRefund: Math.round(interestRefund),
                daysInYear
            };
            
            // Hiển thị nút xuất báo cáo
            document.getElementById('generateReportBtn').style.display = 'block';
            
            // Hiển thị kết quả
            const resultElement = document.getElementById('interestRefundResult');
            resultElement.innerHTML = `
                <p>Thông tin thu hồi ưu đãi lãi suất:</p>
                <p>- Dư nợ gốc thực tế: ${loanAmount.toLocaleString('de-DE')} VND</p>
                <p>- Lãi suất thả nổi/theo thỏa thuận: ${standardRate}%/năm</p>
                <p>- Lãi suất ưu đãi: ${prefRate}%/năm</p>
                <p>- Thời gian ưu đãi: ${promotionalMonths} tháng</p>
                <p>- Chênh lệch lãi suất: ${(standardRate - prefRate).toFixed(2)}%/năm</p>
                <p>- Ngày vay: ${new Date(startDate).toLocaleDateString('vi-VN')}</p>
                <p>- Ngày trả nợ: ${new Date(endDate).toLocaleDateString('vi-VN')}</p>
                <p>- Số ngày thực hưởng ưu đãi: ${actualDays} ngày</p>
                <p>- Phương pháp tính: ${calculationMethod === 'actual365' ? 'Actual/365' : 'Actual/360'}</p>
                <p>- <strong>Tiền thu hồi ưu đãi lãi suất: ${Math.round(interestRefund).toLocaleString('de-DE')} VND</strong></p>
                <p><i>Lưu ý: Khoản thu hồi ưu đãi lãi suất và phí trả nợ trước hạn là hai khoản riêng biệt.</i></p>
            `;
            resultElement.style.display = 'block';
        }
        // Hàm xuất báo cáo chuyên nghiệp
        function generateReport() {
            // Kiểm tra dữ liệu báo cáo
            if (!window.reportData) {
                alert('Vui lòng tính toán trước khi xuất báo cáo!');
                return;
            }
            
            // Lấy dữ liệu từ reportData
            const rd = window.reportData;
            
            // Lấy ngày hiện tại
            const today = new Date();
            const formattedDate = today.toLocaleDateString('vi-VN');
            
            // Tạo nội dung PDF với hỗ trợ tiếng Việt
            const { jsPDF } = window.jspdf;
            
            // Tạo một document PDF mới với font hỗ trợ tiếng Việt
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true
            });
            
            // Sử dụng font mặc định của PDF (Helvetica) hoặc Arial
            // Đặt chế độ encoding cho font
            doc.setFont('helvetica');
            doc.setFontSize(24);
            doc.setTextColor(30, 60, 90);
            
            // Thêm logo (tạo chữ thay logo)
            doc.text('VietinBank', 15, 20);
            
            // Tiêu đề báo cáo - Sử dụng các từ riêng biệt để tránh lỗi font
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0);
            doc.text('BAO CAO THU HOI UU DAI LAI SUAT', 105, 30, { align: 'center' });
            
            // Thông tin ngày tháng
            doc.setFontSize(10);
            doc.text(`Ngay lap: ${formattedDate}`, 190, 20, { align: 'right' });
            doc.text('Mau: 365', 190, 25, { align: 'right' });
            
            // Thông tin khách hàng
            doc.setFontSize(12);
            doc.text('Kinh gui Quy khach hang,', 15, 45);
            
            doc.setFontSize(11);
            let y = 55;
            doc.text('Ngan hang TMCP Cong Thuong Viet Nam (VietinBank) xin tran trong thong bao ve viec thu hoi', 15, y);
            y += 5;
            doc.text('uu dai lai suat theo Thong tu 14/2017/TT-NHNN doi voi khoan vay cua Quy khach, cu the nhu sau:', 15, y);
            
            // Thông tin khoản vay
            y += 10;
            doc.text('THONG TIN CHI TIET:', 15, y);
            y += 7;
            
            // Bảng thông tin
            const tableData = [
                ['Du no goc thuc te:', `${rd.loanAmount.toLocaleString('de-DE')} VND`],
                ['Lai suat tha noi/theo thoa thuan:', `${rd.standardRate}%/nam`],
                ['Lai suat uu dai:', `${rd.prefRate}%/nam`],
                ['Thoi gian uu dai:', `${rd.promotionalMonths} thang`],
                ['Chenh lech lai suat:', `${(rd.rateDiff * 100).toFixed(2)}%/nam`],
                ['Ngay vay:', `${new Date(rd.startDate).toLocaleDateString('vi-VN')}`],
                ['Ngay tra no:', `${new Date(rd.endDate).toLocaleDateString('vi-VN')}`],
                ['So ngay thuc huong uu dai:', `${rd.actualDays} ngay`],
                ['Phuong phap tinh:', `${rd.calculationMethod === 'actual365' ? 'Actual/365' : 'Actual/360'}`],
                ['So tien thu hoi uu dai:', `${rd.interestRefund.toLocaleString('de-DE')} VND`]
            ];
            
            // Thêm bảng vào PDF
            doc.autoTable({
                startY: y,
                head: [],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: {
                    0: { cellWidth: 70, fontStyle: 'bold' },
                    1: { cellWidth: 80 }
                },
                margin: { left: 15 }
            });
            
            // Tính toán vị trí mới
            y = doc.previousAutoTable.finalY + 10;
            
            // Công thức tính toán
            doc.setFontSize(10);
            doc.text('Cong thuc tinh toan:', 15, y);
            y += 5;
            doc.text(`Tien thu hoi = Du no goc x (Lai suat tha noi - Lai suat uu dai) x (So ngay thuc huong uu dai / ${rd.daysInYear})`, 15, y);
            y += 5;
            doc.text(`Tien thu hoi = ${rd.loanAmount.toLocaleString('de-DE')} x (${rd.standardRate}% - ${rd.prefRate}%)% x (${rd.actualDays} / ${rd.daysInYear})`, 15, y);
            y += 5;
            doc.text(`Tien thu hoi = ${rd.loanAmount.toLocaleString('de-DE')} x ${(rd.rateDiff * 100).toFixed(2)}% x ${(rd.actualDays / rd.daysInYear).toFixed(4)}`, 15, y);
            y += 5;
            doc.text(`Tien thu hoi = ${rd.interestRefund.toLocaleString('de-DE')} VND`, 15, y);
            
            // Lưu ý
            y += 10;
            doc.setFontSize(10);
            doc.text('Luu y:', 15, y);
            y += 5;
            doc.text('- Khoan thu hoi uu dai lai suat va phi tra no truoc han (neu co) la hai khoan rieng biet.', 15, y);
            y += 5;
            doc.text('- Bao cao nay duoc tinh toan theo Thong tu 14/2017/TT-NHNN.', 15, y);
            
            // Kết luận
            y += 10;
            doc.setFontSize(11);
            doc.text('VietinBank tran trong thong bao va kinh de nghi Quy khach thanh toan so tien thu hoi uu dai lai suat neu tren', 15, y);
            y += 5;
            doc.text('cung voi so tien goc va lai theo quy dinh cua Hop dong tin dung.', 15, y);
            
            // Chữ ký
            y += 20;
            doc.setFontSize(11);
            doc.text('NGAN HANG TMCP CONG THUONG VIET NAM', 140, y, { align: 'center' });
            y += 5;
            doc.text('(VietinBank)', 140, y, { align: 'center' });
            
            // Tạo tên file
            const filename = `Thu_hoi_uu_dai_lai_suat_${formattedDate.replace(/\//g, '')}.pdf`;
            
            // Tải xuống PDF
            doc.save(filename);
        }
    </script>
</body>
</html>